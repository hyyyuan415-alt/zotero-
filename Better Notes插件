// @author mulei
${await (async () => {
    const getAnnotationsByTag = async (tagName) => {
        const pdfItem = await topItem.getBestAttachment();
        let result = "";
        for (let annoItem of pdfItem.getAnnotations()) {
            if (annoItem.getTags().find(i => i.tag.includes(tagName))) {
                const res = Zotero.EditorInstanceUtilities.serializeAnnotations(
                    [
                        {
                            ...(await Zotero.Annotations.toJSON(annoItem)), ...{ attachmentItemID: annoItem.parentID }
                        }
                    ]
                );
                result += res.html;
            }
        }
        return result;
    };

    // è¾…åŠ©å‡½æ•°ï¼šæ£€æµ‹å­—ç¬¦ä¸²æ˜¯å¦åŒ…å«ä¸­æ–‡å­—ç¬¦
    const containsChinese = (text) => /[\u4e00-\u9fa5]/.test(text);

    // æå–å½±å“å› å­
    let impactFactor = Zotero.ZoteroStyle.api.renderCell(topItem, "publicationTags").textContent.trim();
    let impactFactorValues = impactFactor.match(/\d+(\.\d+)?/g); // æå–æ•°å­—éƒ¨åˆ†

    // è·å–ç¿»è¯‘æ ‡é¢˜ï¼Œå¦‚æœæ²¡æœ‰æˆ–è€…ä¸ºç©ºï¼Œåˆ™ä½¿ç”¨åŸå§‹æ ‡é¢˜
    let titleTranslationMatch = topItem.getField("extra").match(/titleTranslation:(.+)/);
    let titleTranslation = (titleTranslationMatch && titleTranslationMatch[1].trim()) ? titleTranslationMatch[1].trim() : topItem.getField("title");

    // æ£€æŸ¥æ ‡é¢˜æ˜¯å¦ä¸ºä¸­æ–‡
    let isChineseTitle = containsChinese(topItem.getField("title"));

    // æ ¹æ®æ ‡é¢˜è¯­è¨€å†³å®šIFQçš„æ˜¾ç¤ºæ–¹å¼
    let impactFactorDisplay = isChineseTitle ? impactFactor : (impactFactorValues ? impactFactorValues.join(' / ') : '');

    // è·å–ä½œè€…æ˜¾ç¤ºå†…å®¹
    let creators = topItem.getCreators();
    let authorDisplay = "";
    if (isChineseTitle) {
        // ä¸­æ–‡æ ‡é¢˜ï¼šæ˜¾ç¤ºç¬¬ä¸€ä½œè€…å…¨åï¼Œæ ¼å¼ä¸ºâ€œå§“ å‰åâ€
        if (creators.length > 0) {
            let firstAuthor = creators[0];
            let fullName = `${firstAuthor.lastName} ${firstAuthor.firstName}`;
            authorDisplay = fullName;
        }
    } else {
        // éä¸­æ–‡æ ‡é¢˜ï¼šæ˜¾ç¤ºç¬¬ä¸€ä½œè€…å§“æ°å¹¶é™„åŠ â€œet al.â€
        if (creators.length > 0) {
            let firstAuthorLastName = creators[0].lastName;
            authorDisplay = `${firstAuthorLastName} et al.`;
        }
    }

   // è·å–å„éƒ¨åˆ†æ³¨é‡Šå†…å®¹ï¼ˆä¸ Ethereal Style å®Œå…¨ä¸€è‡´ï¼‰
const åˆ›æ–°ç‚¹ = await getAnnotationsByTag('åˆ›æ–°ç‚¹');
const èƒŒæ™¯ = await getAnnotationsByTag('èƒŒæ™¯');
const æ–¹æ³• = await getAnnotationsByTag('æ–¹æ³•');
const ç»“è®º = await getAnnotationsByTag('ç»“è®º');
const è¯­å¥ = await getAnnotationsByTag('è¯­å¥');
const å±•æœ› = await getAnnotationsByTag('å±•æœ›');


    // æ–°å¢éƒ¨åˆ†ï¼šæå– Figure æ ‡ç­¾çš„å†…å®¹
    const getFigureAnnotations = async (item, tag) => {
        let annots = item.getAnnotations();
        annots = annots.filter((annot) => annot.getTags().map(tagObj => tagObj.tag).includes(tag));
        return await Zotero.BetterNotes.api.convert.annotations2html(annots, { noteItem: targetNoteItem });
    };

    const attachments = Zotero.Items.get(topItem.getAttachments()).filter((i) => i.isPDFAttachment());

    let figureRes = "";
    for (let attachment of attachments) {
        const annots = await getFigureAnnotations(attachment, 'Figure');
        figureRes += annots ? annots : "";
    }

    const itemNotes = []; // éœ€è¦è·å–æ–‡çŒ®çš„ç›¸å…³ç¬”è®°
    const notes = itemNotes.filter(noteItem => noteItem.getTags().map(tagObj => tagObj.tag).includes('Figure'));
    const notesWithTags = `${notes.map((noteItem) => {
        const noteLink = Zotero.BetterNotes.api.convert.note2link(noteItem);
        const noteLine = `<p style="color:red; background-color: #efe3da;">ğŸ“œ Article Note:  <a href="${noteLink}">${noteItem.getNoteTitle() || noteLink}</a></p>
<p>tags: ${noteItem.getTags().map(tagObj => tagObj.tag).join(', ')}</p>
<p> </p>`;
        return noteLine;
    }).join("\n")}`;

    figureRes += notesWithTags;

    // ç”Ÿæˆæ ‡é¢˜ï¼Œå¤„ç†ä¸­æ–‡å’Œè‹±æ–‡æƒ…å†µ
    let res = `<h1>ğŸ”¤${titleTranslation} (<span style="background-color: #B1A5E1">${topItem.getField("year")}</span>, <span style="background-color: #CBE1A5">${authorDisplay}</span>) ${topItem.getField("journalAbbreviation")} (${impactFactorDisplay})</h1>
<p><strong><span style="color: #283593">åŸåï¼š</span></strong>${topItem.getField('title')}</p>
<p><strong><span style="color: #283593">è¯‘åï¼š</span></strong>${titleTranslation}</p>
<p><strong><span style="color: #283593">ä½œè€…ï¼š</span></strong>${authorDisplay}</p>
<p><strong><span style="color: #283593">æœŸåˆŠï¼š</span></strong>${topItem.getField('publicationTitle')}</p>
<p><strong><span style="color: #283593">IFQï¼š</span></strong><span style="">

${{
let space = " ã…¤ã…¤ ã…¤ã…¤"
return Array.prototype.map.call(
	Zotero.ZoteroStyle.api.renderCell(topItem, "publicationTags").childNodes,
	e => {
		e.innerText =  space + e.innerText + space;
		return e.outerHTML
	}
	).join(space)
}}$
</p >

${(() => {
        const doi = topItem.getField("DOI");
        if (doi) {
            return `<b><span style="color: #283593">DOIï¼š</span></strong> </b><a href="https://doi.org/${topItem.getField('DOI')}">${topItem.getField('DOI')}</a>`;
        } else {
            return `<b><span style="color: #283593">URLï¼š</span></strong> </b><a href="${topItem.getField('url')}">${topItem.getField('url')}</a>`;
        }
    })()}
<p><strong><span style="color: #283593">å‘è¡¨æ—¶é—´ï¼š</span></strong>${topItem.getField('date')}</p>

<!-- æœ¬åœ°é“¾æ¥ -->
<tr>
  <td style="color:#193c47; background-color:#dbeedd; padding:8px;">
    ${(() => {
        const attachments = Zotero.Items.get(topItem.getAttachments());
        if (attachments && attachments.length > 0) {
            return `<b><span style="color: #283593">æœ¬åœ°é“¾æ¥:</span> </b><a href="zotero://open-pdf/0_${attachments[0].key}">${attachments[0].getFilename()}</a>`;
        } else {
            return `<b><span style="color: #283593">æœ¬åœ°é“¾æ¥:</span> </b>`;
        }
    })()}
  </td>
</tr>
<p>
<!-- æ‘˜è¦ -->
<tr>
  <td style="color:#193c47; background-color:#dbeedd; padding:8px;">
    ${(() => {
        const abstractTranslation = topItem.getField('abstractTranslation');
        if (abstractTranslation) {
            return `<b><span style="color: #283593">æ‘˜è¦ç¿»è¯‘ï¼š</span> </b><i>${abstractTranslation}</i>`;
        } else {
            return `<b><span style="color: #283593">æ‘˜è¦ï¼š</span> </b><i>${topItem.getField('abstractNote')}</i>`;
        }
    })()}
  </td>
</tr>

<!-- ç”Ÿæˆæ ‡ç­¾ç¬”è®° -->
${åˆ›æ–°ç‚¹ ? `<h3><span style="color:#A61B41">ğŸ’¡ åˆ›æ–°ç‚¹</span></h3>${åˆ›æ–°ç‚¹}` : ''}

${èƒŒæ™¯ ? `<h3><span style="color:#A61B41">ğŸŒ èƒŒæ™¯</span></h3>${èƒŒæ™¯}` : ''}

${æ–¹æ³• ? `<h3><span style="color:#A61B41">ğŸ”¬ æ–¹æ³•</span></h3>${æ–¹æ³•}` : ''}

${ç»“è®º ? `<h3><span style="color:#A61B41">ğŸ“œ ç»“è®º</span></h3>${ç»“è®º}` : ''}

${è¯­å¥ ? `<h3><span style="color:#A61B41">ğŸ§¾ è¯­å¥æ‘˜å½•</span></h3>${è¯­å¥}` : ''}

${å±•æœ› ? `<h3><span style="color:#A61B41">ğŸ”­ å±•æœ›</span></h3>${å±•æœ›}` : ''}


`;

    return res;
})()}
æˆ‘å¯ä»¥åº”ç”¨åˆ°æˆ‘çš„è¿™ä¸ªä¸Šå—
