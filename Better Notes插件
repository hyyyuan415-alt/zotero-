// @author mulei
${await (async () => {

    /* ================= å·¥å…·å‡½æ•° ================= */

    const getAnnotationsByTag = async (tagName) => {
        const pdfItem = await topItem.getBestAttachment();
        let result = "";
        for (let annoItem of pdfItem.getAnnotations()) {
            if (annoItem.getTags().find(i => i.tag.includes(tagName))) {
                const res = Zotero.EditorInstanceUtilities.serializeAnnotations(
                    [
                        {
                            ...(await Zotero.Annotations.toJSON(annoItem)),
                            attachmentItemID: annoItem.parentID
                        }
                    ]
                );
                result += res.html;
            }
        }
        return result;
    };

    const containsChinese = (text) => /[\u4e00-\u9fa5]/.test(text);

    /* ================= æ ‡é¢˜ä¸ä½œè€… ================= */

    let titleTranslationMatch = topItem.getField("extra").match(/titleTranslation:(.+)/);
    let titleTranslation = (titleTranslationMatch && titleTranslationMatch[1].trim())
        ? titleTranslationMatch[1].trim()
        : topItem.getField("title");

    let isChineseTitle = containsChinese(topItem.getField("title"));

    let creators = topItem.getCreators();
    let authorDisplay = "";
    if (creators.length > 0) {
        if (isChineseTitle) {
            authorDisplay = `${creators[0].lastName} ${creators[0].firstName}`;
        } else {
            authorDisplay = `${creators[0].lastName} et al.`;
        }
    }

    /* ================= æ³¨é‡Šå†…å®¹ï¼ˆä¸ä½ çš„ Ethereal Style å®Œå…¨ä¸€è‡´ï¼‰ ================= */

    const åˆ›æ–°ç‚¹ = await getAnnotationsByTag('åˆ›æ–°ç‚¹');
    const èƒŒæ™¯   = await getAnnotationsByTag('èƒŒæ™¯');
    const æ–¹æ³•   = await getAnnotationsByTag('æ–¹æ³•');
    const ç»“è®º   = await getAnnotationsByTag('ç»“è®º');
    const è¯­å¥   = await getAnnotationsByTag('è¯­å¥');
    const å±•æœ›   = await getAnnotationsByTag('å±•æœ›');

    /* ================= ç”Ÿæˆç¬”è®° ================= */

    let res = `
<h1>
ğŸ”¤${titleTranslation}
(<span style="background-color:#B1A5E1">${topItem.getField("year")}</span>,
<span style="background-color:#CBE1A5">${authorDisplay}</span>)
${topItem.getField("journalAbbreviation")}
</h1>

<p><strong><span style="color:#283593">åŸåï¼š</span></strong>${topItem.getField('title')}</p>
<p><strong><span style="color:#283593">è¯‘åï¼š</span></strong>${titleTranslation}</p>
<p><strong><span style="color:#283593">ä½œè€…ï¼š</span></strong>${authorDisplay}</p>
<p><strong><span style="color:#283593">æœŸåˆŠï¼š</span></strong>${topItem.getField('publicationTitle')}</p>

${(() => {
    const doi = topItem.getField("DOI");
    return doi
        ? `<p><strong><span style="color:#283593">DOIï¼š</span></strong>
           <a href="https://doi.org/${doi}">${doi}</a></p>`
        : `<p><strong><span style="color:#283593">URLï¼š</span></strong>
           <a href="${topItem.getField('url')}">${topItem.getField('url')}</a></p>`;
})()}

<p><strong><span style="color:#283593">å‘è¡¨æ—¶é—´ï¼š</span></strong>${topItem.getField('date')}</p>

<hr/>

${åˆ›æ–°ç‚¹ ? `<h3>ğŸ’¡ åˆ›æ–°ç‚¹</h3>${åˆ›æ–°ç‚¹}` : ''}
${èƒŒæ™¯   ? `<h3>ğŸŒ èƒŒæ™¯</h3>${èƒŒæ™¯}`     : ''}
${æ–¹æ³•   ? `<h3>ğŸ”¬ æ–¹æ³•</h3>${æ–¹æ³•}`     : ''}
${ç»“è®º   ? `<h3>ğŸ“œ ç»“è®º</h3>${ç»“è®º}`     : ''}
${è¯­å¥   ? `<h3>ğŸ§¾ è¯­å¥æ‘˜å½•</h3>${è¯­å¥}` : ''}
${å±•æœ›   ? `<h3>ğŸ”­ å±•æœ›</h3>${å±•æœ›}`     : ''}
`;

    return res;
})()}
