// @author mulei
${await (async () => {
    const getAnnotationsByTag = async (tagName) => {
        const pdfItem = await topItem.getBestAttachment();
        let result = "";
        for (let annoItem of pdfItem.getAnnotations()) {
            if (annoItem.getTags().find(i => i.tag.includes(tagName))) {
                const res = Zotero.EditorInstanceUtilities.serializeAnnotations(
                    [
                        {
                            ...(await Zotero.Annotations.toJSON(annoItem)),
                            attachmentItemID: annoItem.parentID
                        }
                    ]
                );
                result += res.html;
            }
        }
        return result;
    };

    const containsChinese = (text) => /[\u4e00-\u9fa5]/.test(text || "");

    let titleTranslationMatch = topItem.getField("extra")?.match(/titleTranslation:(.+)/);
    let titleTranslation = (titleTranslationMatch && titleTranslationMatch[1].trim())
        ? titleTranslationMatch[1].trim()
        : topItem.getField("title");

    let isChineseTitle = containsChinese(topItem.getField("title"));

    let creators = topItem.getCreators();
    let authorDisplay = "";
    if (creators.length > 0) {
        authorDisplay = isChineseTitle
            ? `${creators[0].lastName} ${creators[0].firstName}`
            : `${creators[0].lastName} et al.`;
    }

    const åˆ›æ–°ç‚¹ = await getAnnotationsByTag('åˆ›æ–°ç‚¹');
    const èƒŒæ™¯ = await getAnnotationsByTag('èƒŒæ™¯');
    const æ–¹æ³• = await getAnnotationsByTag('æ–¹æ³•');
    const ç»“è®º = await getAnnotationsByTag('ç»“è®º');
    const è¯­å¥ = await getAnnotationsByTag('è¯­å¥');
    const å±•æœ› = await getAnnotationsByTag('å±•æœ›');

    const getFigureAnnotations = async (item, tag) => {
        let annots = item.getAnnotations()
            .filter(a => a.getTags().map(t => t.tag).includes(tag));
        return await Zotero.BetterNotes.api.convert.annotations2html(
            annots,
            { noteItem: targetNoteItem }
        );
    };

    const attachments = Zotero.Items
        .get(topItem.getAttachments())
        .filter(i => i.isPDFAttachment());

    let figureRes = "";
    for (let attachment of attachments) {
        figureRes += (await getFigureAnnotations(attachment, 'Figure')) || "";
    }

    let res = `
<h1>ğŸ”¤${titleTranslation} (
<span style="background-color:#B1A5E1">${topItem.getField("year")}</span>,
<span style="background-color:#CBE1A5">${authorDisplay}</span>
) ${topItem.getField("journalAbbreviation")}</h1>

<p><strong><span style="color:#283593">åŸåï¼š</span></strong>${topItem.getField("title")}</p>
<p><strong><span style="color:#283593">è¯‘åï¼š</span></strong>${titleTranslation}</p>

<p>
<strong><span style="color:#283593">ä½œè€…ï¼š</span></strong>${authorDisplay}
<span style="color:#999"> / </span>
<strong><span style="color:#283593">æœŸåˆŠï¼š</span></strong>${topItem.getField("publicationTitle")}
<span style="color:#999"> / </span>
<strong><span style="color:#283593">å‘è¡¨æ—¶é—´ï¼š</span></strong>${topItem.getField("date")}
</p>

${(() => {
    const doi = topItem.getField("DOI");
    return doi
        ? `<p><strong><span style="color:#283593">DOIï¼š</span></strong>
           <a href="https://doi.org/${doi}">${doi}</a></p>`
        : `<p><strong><span style="color:#283593">URLï¼š</span></strong>
           <a href="${topItem.getField("url")}">${topItem.getField("url")}</a></p>`;
})()}

<tr>
<td style="color:#193c47; background-color:#dbeedd; padding:8px;">
${(() => {
    const atts = Zotero.Items.get(topItem.getAttachments());
    return atts.length
        ? `<b>æœ¬åœ°é“¾æ¥ï¼š</b><a href="zotero://open-pdf/0_${atts[0].key}">${atts[0].getFilename()}</a>`
        : `<b>æœ¬åœ°é“¾æ¥ï¼š</b>`;
})()}
</td>
</tr>

<tr>
<td style="color:#193c47; background-color:#dbeedd; padding:8px;">
${(() => {
    const absTrans = topItem.getField("abstractTranslation");
    return absTrans
        ? `<b>æ‘˜è¦ç¿»è¯‘ï¼š</b><i>${absTrans}</i>`
        : `<b>æ‘˜è¦ï¼š</b><i>${topItem.getField("abstractNote")}</i>`;
})()}
</td>
</tr>

${åˆ›æ–°ç‚¹ ? `<h3><span style="color:#A61B41">ğŸ’¡ åˆ›æ–°ç‚¹</span></h3>${åˆ›æ–°ç‚¹}` : ""}
${èƒŒæ™¯ ? `<h3><span style="color:#A61B41">ğŸŒ èƒŒæ™¯</span></h3>${èƒŒæ™¯}` : ""}
${æ–¹æ³• ? `<h3><span style="color:#A61B41">ğŸ”¬ æ–¹æ³•</span></h3>${æ–¹æ³•}` : ""}
${ç»“è®º ? `<h3><span style="color:#A61B41">ğŸ“œ ç»“è®º</span></h3>${ç»“è®º}` : ""}
${è¯­å¥ ? `<h3><span style="color:#A61B41">ğŸ§¾ è¯­å¥æ‘˜å½•</span></h3>${è¯­å¥}` : ""}
${å±•æœ› ? `<h3><span style="color:#A61B41">ğŸ”­ å±•æœ›</span></h3>${å±•æœ›}` : ""}

${figureRes}
`;

    return res;
})()}
